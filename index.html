<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frame Counter App</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #flex {
      display: flex;
    }

    .dropzone {
      border: 2px dashed #cccccc;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
    }

    #video-container {
      position: relative;
      width: 90%; /* ウィンドウの80%に制限 */
      max-width: 1280px; /* 最大幅を800pxに制限 */
    }

    #video {
      width: 100%;
    }

    #frame-counter {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #frame-text {
      font-size: 2em;
      fill: white;
      dominant-baseline: middle;
      text-anchor: middle;
    }

    #button-container {
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div id="flex">
  <div id=movie-selector class="dropzone" onclick="openFileSelector()">
    <p>Click or drag & drop a video file here</p>
    <input type="file" id="file-input" accept="video/*" style="display: none;" onchange="handleFileChange()">
    <p id="movie-name"></p>
  </div>
  <div id=json-selector class="dropzone" onclick="openJsonFileSelector()">
    <p>Click or drag & drop a json file here</p>
    <input type="file" id="file-input-json" accept="application/json" style="display: none;" onchange="handleJsonFileChange()">
    <p id="json-name"></p>
  </div>
  <a href="#" id="downloadLink">
    <div class="dropzone" >
      <p>Save</p>
    </div>
  </a>
</div>

<div id="video-container" style="display: none; margin-top: 30px;">
  <video id="video" controls></video>
  <svg id="frame-counter">
    <text id="frame-text"></text>
    <g stroke="black" fill="none">
      <rect id='field' x="0" y="0" width="200" height="200" ></rect>
      <rect id="p00" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p01" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p02" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p03" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p04" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p05" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p06" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p07" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p08" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p09" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p10" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p11" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p12" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p13" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p14" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p15" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p16" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p17" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p18" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p19" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p20" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p21" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p22" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p23" x="0" y="0" width="10" height="10" ></rect>
      <rect id="p24" x="0" y="0" width="10" height="10" ></rect>  
    </g>
  </svg>
</div>
<div id="button-container" style="display: none;">
  <button onclick="handlePlayPause()">Play/Pause</button>
  <button onclick="handleFrameBackward()">Previous Frame</button>
  <button onclick="handleFrameForward()">Next Frame</button>
</div>
<div id="data-container" style="margin-top: 30px;">
  <div id="frame-count"></div>
  <div id="-object-id"></div>
  <label for="object-id">Object ID:</label>
  <input type="text" id="object-id" name="object-id"
    onchange="handleSetObjectId(this.value)">
  <div id="-team-id"></div>
  <label for="team-id">Team:</label>
  <input type="text" id="team-id" name="team-id"
    onchange="handleSetTeamId(this.value)">
  <div id="f_x"></div>
  <div id="f_y"></div>
  <div id="k_x"></div>
  <div id="k_y"></div>
  <div id="k_w"></div>
  <div id="k_h"></div>
</div>

<script>
  let video;
  let frameCounter;
  let frameText;
  let currentFrame = 0;
  let isPlaying = false;

  function openFileSelector() {
    document.getElementById('file-input').click();
  }

  function handleFileChange() {
    const fileInput = document.getElementById('file-input');
    const videoContainer = document.getElementById('video-container');
    const videoElement = document.getElementById('video');;
    const frameCounterElement = document.getElementById('frame-counter');
    const frameTextElement = document.getElementById('frame-text');

    const file = fileInput.files[0];

    if (file) {
      videoContainer.style.display = 'block';

      video = new VideoPlayer(videoElement, file);
      video.onPlay(handlePlay);
      video.onPause(handlePause);

      frameCounter = frameCounterElement;
      frameText = frameTextElement;

      document.getElementById('movie-name').innerHTML = file.name;

      updateFrameText();

      // キーボードのイベントリスナーを設定
      document.addEventListener('keydown', handleKeyPress);
    }
  }

  document.getElementById('downloadLink').addEventListener('click', function() {
    // const result = openJsonFileDownloader();
    console.log('download');
    const fileContent = JSON.stringify(video.jsonData);
    const blob = new Blob([fileContent], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const currentDate = new Date();
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // 月は0から始まるため+1が必要
    const day = String(currentDate.getDate()).padStart(2, '0');
    const hours = String(currentDate.getHours()).padStart(2, '0');
    const minutes = String(currentDate.getMinutes()).padStart(2, '0');

    this.href = url;
    this.download = `${year}${month}${day}_${hours}${minutes}-integration.json`;
  });

  function openJsonFileDownloader() {
    console.log('download');
    const fileContent = JSON.stringify(video.jsonData);
    const blob = new Blob([fileContent], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    // file名作成
    const currentDate = new Date();
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // 月は0から始まるため+1が必要
    const day = String(currentDate.getDate()).padStart(2, '0');
    const hours = String(currentDate.getHours()).padStart(2, '0');
    const minutes = String(currentDate.getMinutes()).padStart(2, '0');
    
    return [url, `${year}${month}${day}_${hours}${minutes}-integration.json`];
  }

  function openJsonFileSelector() {
    document.getElementById('file-input-json').click();
  }

  function handleJsonFileChange() {
    const fileInput = document.getElementById('file-input-json');

    const file = fileInput.files[0];

    if (file) {
      if (file.type === 'application/json') {
        // Read the JSON file
        const reader = new FileReader();
        reader.onload = function (e) {
          const jsonContent = e.target.result;
          handleJSONContent(jsonContent, file);
          document.getElementById('json-name').innerHTML = file.name;
        };
        reader.readAsText(file);
      }
    }
  }
  
  function handleJSONContent(jsonContent, file) {
    // Parse the JSON content
    const jsonData = JSON.parse(jsonContent);

    // Handle the JSON data as needed
    console.log(jsonData);

    video.addJson(file, jsonData);
  }

  function handlePlayPause() {
    if (isPlaying) {
      video.pause();
    } else {
      video.play();
    }
  }

  function handlePlay() {
    isPlaying = true;
  }

  function handlePause() {
    isPlaying = false;
    currentFrame = video.currentTime * video.fps;
    updateFrameText();
  }

  function handleKeyPress(event) {
    // 右矢印キーで次のフレーム
    if (event.key === 'ArrowRight') {
      handleFrameForward();
    }
    // 左矢印キーで前のフレーム
    else if (event.key === 'ArrowLeft') {
      handleFrameBackward();
    }
    else if (event.key === 'ArrowUp') {
      handlePlayerForward();
    }
    else if (event.key === 'ArrowDown') {
      handlePlayerBackward();
    }
  }

  function handleFrameForward() {
    currentFrame += 1;
    video.seek(currentFrame / video.fps);
    updateFrameText();
  }

  function handleFrameBackward() {
    currentFrame = Math.max(currentFrame - 1, 0);
    video.seek(currentFrame / video.fps);
    updateFrameText();
  }

  function handlePlayerForward() {
    console.log('player forward')
    video.playerIndex--;
    updateFrameText();
  }

  function handlePlayerBackward() {
    console.log('player backward')
    video.playerIndex++;
    updateFrameText();
  }

  function handleSetObjectId(value) {
    const f = video.jsonData.frames[video.lastFrameIndex];
    const p = f.players[video.lastPlayerIndex];
    console.log(p);
    p.player_id = Number(value);
    console.log(p);
  }

  function handleSetTeamId(value) {
    const f = video.jsonData.frames[video.lastFrameIndex];
    const p = f.players[video.lastPlayerIndex];
    console.log(p);
    p.team_id = Number(value);
    console.log(p);
  }

  const dataContainerElement = document.getElementById('data-container');
  const frameCountTextElement = document.getElementById('frame-count');
  const objectIdTextElement = document.getElementById('object-id');
  const teamIdTextElement = document.getElementById('team-id');
  const FXTextElement = document.getElementById('f_x');
  const FYTextElement = document.getElementById('f_y');
  const KXTextElement = document.getElementById('k_x');
  const KYTextElement = document.getElementById('k_y');
  const KWTextElement = document.getElementById('k_w');
  const KHTextElement = document.getElementById('k_h');
  const PlayerRectElement = document.getElementById('player-rect');


  function updateFrameText() {
    currentFrame = video.currentTime * video.fps;
    frameText.innerHTML = Math.round(currentFrame);
    if (video.jsonData != null) {
      const frameIndex = Math.floor(currentFrame);
      if (frameIndex == video.lastFrameIndex 
        && video.lastPlayerIndex == video.playerIndex) {
        return;
      }
      
      const frame = video.jsonData.frames[frameIndex];
      // playerIndex のチェック
      if (video.playerIndex < 0) {
        video.playerIndex = frame.players.length - 1;
      }
      if (video.playerIndex >= frame.players.length) {
        video.playerIndex = 0;
      }

      console.log(video.playerIndex);

      const player = frame.players[video.playerIndex];
      objectIdTextElement.value = player.player_id;
      teamIdTextElement.value = player.team_id;
      FXTextElement.innerHTML = player.fukan.x;
      FYTextElement.innerHTML = player.fukan.y;
      KXTextElement.innerHTML = player.kankyaku.x;
      KYTextElement.innerHTML = player.kankyaku.y;
      KWTextElement.innerHTML = player.kankyaku.w;
      KHTextElement.innerHTML = player.kankyaku.h;


      frame.players.forEach((player, i) => {
        const player_id = 'p' + ('0' + i).slice(-2);
        const playerRect = document.getElementById(player_id);
        playerRect.setAttribute('x', player.xy[0] - player.kankyaku.w / 2);
        playerRect.setAttribute('y', player.xy[1]);
        playerRect.setAttribute('width', 40);
        playerRect.setAttribute('height', 10);
        let fill = player.team_id == 0? 'red': 'white';
        if (i == video.playerIndex) {
          fill = 'blue';
        }
        playerRect.setAttribute('fill', fill);
        playerRect.innerHTML = player.player_id;
      });
      frameCountTextElement.innerHTML = Math.floor(currentFrame) + '/' + frame.index;

      // last情報更新
      video.lastPlayerIndex = video.playerIndex;
      video.lastFrameIndex = frameIndex;
    }
  }

  class VideoPlayer {
    constructor(element, file) {
      this.element = element;
      this.file = file;
      this.currentTime = 0;
      this.jsonFile = null;
      this.jsonData = null;
      this.playerIndex = 0;
      this.fps = 30; // Change this value based on the actual frames per second of your video.
      this.init();
    }

    init() {
      this.element.src = URL.createObjectURL(this.file);
      this.element.addEventListener('loadedmetadata', () => {
        this.fps = this.element.duration / this.element.duration;
        console.log(this.element.duration);
        this.fps = 29.97;
        
        console.log(this.element.clientWidth);
        console.log(this.element.clientHeight);
        console.log(this.element.videoWidth);
        console.log(this.element.videoHeight);
        frameCounter.setAttribute('viewBox', '0 0 ' + this.element.videoWidth + ' ' + this.element.videoHeight);
        //frameCounter.setAttribute('viewBox', '0 0 ' + this.element.clientWidth + ' ' + this.element.clientHeight);
        //frameCounter.setAttribute('width', this.element.videoWidth);
        //frameCounter.setAttribute('height', this.element.videoHeight);
        //frameCounter.setAttribute('width', this.element.clientWidth);
        frameCounter.setAttribute('height', this.element.clientHeight);
        document.getElementById('field').setAttribute('width', this.element.videoWidth)
        document.getElementById('field').setAttribute('height', this.element.videoHeight);
        console.log(frameCounter.viewBox);

      });
      if (this.animeFrameHandler != undefined) {
        cancelAnimationFrame(this.animeFrameHandler.id);
      }
      let loopFactry = function(func){
        let handler = {};
        let loop = function(){
          func();
          // 次のフレーム時の処理の実行を予約
          handler.id = requestAnimationFrame(loop);
        };
        // 初回呼び出し
        handler.id = requestAnimationFrame(loop);
        return handler;
      }
      this.animeFrameHandler = loopFactry(updateFrameText);
    }
    seek(time) {
      this.currentTime = time;
      this.element.currentTime = time;
    }

    onPlay(callback) {
      this.element.addEventListener('play', callback);
    }

    onPause(callback) {
      this.element.addEventListener('pause', callback);
    }

    get currentTime() {
      return this.element.currentTime;
    }

    set currentTime(time) {
      this.element.currentTime = time;
    }

    play() {
      this.element.play();
    }

    pause() {
      this.element.pause();
    }

    addJson(file, jsonData) {
      this.jsonFile = file;
      this.jsonData = jsonData;

      this.jsonData.frames.forEach((frame, i) => {
        if (i % 100 == 0 ) {
          console.log('frame: ' + i)
        }
        frame.players.forEach((player) => {
          const foot = [
            player.kankyaku.x + player.kankyaku.w / 2,
            player.kankyaku.y + player.kankyaku.h
          ];
          player.xy = resize(foot, upper_size, input_video_size);
        })
      });
      updateFrameText();
    }
  }
  /*
    from tracking_flow
  */
  const output_size_ratio = 1.0; // or 0.6, 1.2
  
  const upper_size = [
    2800 * output_size_ratio,
    1000 * output_size_ratio
  ];
  
  const input_video_size = [
    1400 * output_size_ratio,
    1000 * output_size_ratio
  ];

  const field = {
    PITCH_LENGTH: 1050.0,
    PITCH_WIDTH: 680.0
  };
  /*
    def transform(xy, size, field):
        # 絶対座標を出力下画面の位置へ変換
        tx = xy[0] / field.PITCH_LENGTH * size[0] + size[0] / 2
        ty = xy[1] / field.PITCH_WIDTH * size[1] + size[1] / 2
        return int(tx), int(ty)
  */
  function transform(xy, size, field) {
    const tx = xy[0] / field.PITCH_LENGTH * size[0] + size[0] / 2;
    const ty = xy[1] / field.PITCH_WIDTH * size[1] + size[1] / 2;
    return [tx, ty];
  }
  /*
    def resize(oxy, size, video_size):
        rx = oxy[0] / video_size[0] * size[0]
        ry = oxy[1] / video_size[1] * size[1]
        return int(rx), int(ry)
  */
  function resize(oxy, size, video_size) {
    const rx = oxy[0] / video_size[0] * size[0];
    const ry = oxy[1] / video_size[1] * size[1];
    return [rx, ry];
  }
  
</script>

</body>
</html>
